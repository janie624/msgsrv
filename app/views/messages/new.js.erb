var messageFormRecipientsFieldInit = function(form) {
  form.find('#message_recipient_ids').tokenInput("<%= recipients_url %>", {
    theme: 'athletetrax',
    prePopulate: $.parseJSON(form.find('#recipients_json').val()),
    propertyToSearch: 'name',
    preventDuplicates: true,
    crossDomain: false
  });
};

var newMessageFormDialog = $('body').append('<%= j render("/messages/modal", :message => @message) %>').find('#modal_message').modal().on('hidden', function (e) { $(this).remove(); });

messageFormRecipientsFieldInit(newMessageFormDialog.find('form'));
newMessageFormDialog.on('ajax:success', function() {
  messageFormRecipientsFieldInit($(this).find('form'));
});
